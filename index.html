<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Test de Dígitos</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 40px; }
    #sequence { font-size: 2em; margin: 20px; font-weight: bold; }
    input, button { padding: 10px; font-size: 1em; margin: 10px; }
    .hidden { display: none; }
    #historial { max-width: 700px; margin: 30px auto; text-align: left; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background-color: #f2f2f2; }
  </style>
</head>
<body>
  <h1>Test de Dígitos (Digit Span)</h1>

  <button onclick="startTest('directo')">Comenzar Dígitos Directo</button>
  <button onclick="startTest('inverso')">Comenzar Dígitos Inverso</button>
  <button id="btnFinalizar" class="hidden" onclick="finalizarTest()">Finalizar Test</button>

  <div id="sequence" class="hidden"></div>

  <div id="inputArea" class="hidden">
    <p id="instrucciones"></p>
    <input type="text" id="respuesta" placeholder="Escribe la secuencia" autocomplete="off" />
    <button onclick="checkAnswer()">Enviar</button>
  </div>

  <p id="resultado"></p>
  <p id="scoreDisplay"></p>

  <div id="historial" class="hidden">
    <h2>Historial</h2>
    <table>
      <thead>
        <tr>
          <th>Nivel</th>
          <th>Modo</th>
          <th>Secuencia Generada</th>
          <th>Tu Respuesta</th>
          <th>Correcto</th>
        </tr>
      </thead>
      <tbody id="tablaHistorial"></tbody>
    </table>
  </div>

<script>
  let currentSequence = [];
  let modo = "directo";
  let nivel = 4;
  let score = 0;
  let historial = [];
  let testActivo = false;
  let timeoutId = null;
  let intentoRepetido = false; // para saber si estamos en el segundo intento del mismo nivel

  function generarSecuencia(longitud) {
    let seq = [];
    for (let i = 0; i < longitud; i++) {
      seq.push(Math.floor(Math.random() * 9) + 1);
    }
    return seq;
  }

  function startTest(tipo) {
    modo = tipo;
    nivel = 4;
    score = 0;
    historial = [];
    testActivo = true;
    intentoRepetido = false;
    clearTimeout(timeoutId);

    document.getElementById("historial").classList.add("hidden");
    document.getElementById("tablaHistorial").innerHTML = "";
    document.getElementById("scoreDisplay").textContent = "";
    document.getElementById("resultado").textContent = "";
    document.getElementById("btnFinalizar").classList.remove("hidden");

    nextLevel();
  }

function nextLevel() {
  if (!testActivo) return;

  let nuevaSecuencia;

  do {
    nuevaSecuencia = generarSecuencia(nivel);
  } while (intentoRepetido && arraysIguales(nuevaSecuencia, currentSequence));

  currentSequence = nuevaSecuencia;

  document.getElementById("sequence").textContent = currentSequence.join(" ");
  document.getElementById("sequence").classList.remove("hidden");
  document.getElementById("inputArea").classList.add("hidden");
  document.getElementById("respuesta").value = "";

  const tiempoMostrar = nivel * 1000;

  timeoutId = setTimeout(() => {
    document.getElementById("sequence").classList.add("hidden");
    document.getElementById("inputArea").classList.remove("hidden");
    document.getElementById("instrucciones").textContent =
      modo === "directo"
        ? "Escribe los números en el mismo orden:"
        : "Escribe los números en orden inverso:";
    document.getElementById("respuesta").focus();
  }, tiempoMostrar);
}

// Función para comparar dos arrays (secuencias)
function arraysIguales(a, b) {
  if (a.length !== b.length) return false;
  for (let i = 0; i < a.length; i++) {
    if (a[i] !== b[i]) return false;
  }
  return true;
}

  function checkAnswer() {
    if (!testActivo) return;

    clearTimeout(timeoutId);

    let input = document.getElementById("respuesta").value.trim();
    input = input.replace(/\s+/g, ''); // eliminar espacios internos
    let respuestaUsuario = input.split('').map(Number);

    let secuenciaCorrecta =
      modo === "directo" ? currentSequence : [...currentSequence].reverse();

    let esCorrecto =
      respuestaUsuario.length === secuenciaCorrecta.length &&
      respuestaUsuario.every((num, i) => num === secuenciaCorrecta[i]);

    if (esCorrecto) {
      score++;
      historial.push({
        nivel: nivel,
        modo: modo,
        generado: currentSequence.slice(),
        respuesta: respuestaUsuario.slice(),
        correcto: true,
      });
      document.getElementById("resultado").textContent = `✅ Correcto (Puntaje: ${score})`;
      intentoRepetido = false;
      nivel++;
    } else {
      historial.push({
        nivel: nivel,
        modo: modo,
        generado: currentSequence.slice(),
        respuesta: respuestaUsuario.slice(),
        correcto: false,
      });

      if (intentoRepetido) {
        // Segundo intento fallido: finalizar test
        document.getElementById("resultado").textContent = `❌ Incorrecto nuevamente. Prueba finalizada. Puntaje final: ${score}`;
        finalizarTest();
        return;
      } else {
        // Primer fallo, repetir mismo nivel
        document.getElementById("resultado").textContent = `❌ Incorrecto. Se repetirá el nivel ${nivel}.`;
        intentoRepetido = true;
      }
    }

    actualizarHistorial();

    // Si el test no se finalizó en el bloque anterior
    if (testActivo) {
      timeoutId = setTimeout(() => {
        document.getElementById("resultado").textContent = "";
        nextLevel();
      }, 2000);
    }
  }

  function finalizarTest() {
    testActivo = false;
    clearTimeout(timeoutId);
    document.getElementById("sequence").classList.add("hidden");
    document.getElementById("inputArea").classList.add("hidden");
    document.getElementById("btnFinalizar").classList.add("hidden");
    document.getElementById("scoreDisplay").textContent = `Puntaje final: ${score}`;
    document.getElementById("historial").classList.remove("hidden");
  }

  function actualizarHistorial() {
    document.getElementById("scoreDisplay").textContent = `Puntaje actual: ${score}`;
    document.getElementById("historial").classList.remove("hidden");

    let tabla = document.getElementById("tablaHistorial");
    tabla.innerHTML = "";

    historial.forEach((item) => {
      let fila = document.createElement("tr");
      fila.innerHTML = `
        <td>${item.nivel}</td>
        <td>${item.modo}</td>
        <td>${item.generado.join(" ")}</td>
        <td>${item.respuesta.join(" ")}</td>
        <td>${item.correcto ? "✅" : "❌"}</td>
      `;
      tabla.appendChild(fila);
    });
  }
</script>

</body>
</html>
